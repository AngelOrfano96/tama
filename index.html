<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Tamagotchi Browser</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .fullscreen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }
    .center {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hidden { display: none !important; }
    body, html { height: 100%; min-height: 100vh; }
  </style>
</head>
<body>
  <div id="app-root">
    <!-- Login / Registrazione -->
    <div id="login-container" class="fullscreen center">
      <form id="auth-form" class="form-box">
        <h2>Login / Registrati</h2>
        <input type="email" id="email-input" placeholder="Email" required />
        <input type="password" id="password-input" placeholder="Password" required />
        <div class="buttons">
          <button type="submit" id="login-btn">Entra</button>
          <button type="button" id="signup-btn">Registrati</button>
        </div>
        <div id="auth-error" class="error"></div>
      </form>
    </div>

    <!-- Selezione Uovo -->
    <div id="egg-selection" class="fullscreen center hidden">
      <div class="form-box">
        <h2>Scegli un uovo</h2>
        <div class="eggs-grid">
          <img src="assets/eggs/egg_1.png" class="egg selectable" data-egg="1" />
          <img src="assets/eggs/egg_2.png" class="egg selectable" data-egg="2" />
          <img src="assets/eggs/egg_3.png" class="egg selectable" data-egg="3" />
          <img src="assets/eggs/egg_4.png" class="egg selectable" data-egg="4" />
          <img src="assets/eggs/egg_5.png" class="egg selectable" data-egg="5" />
          <img src="assets/eggs/egg_6.png" class="egg selectable" data-egg="6" />
          <img src="assets/eggs/egg_7.png" class="egg selectable" data-egg="7" />
          <img src="assets/eggs/egg_8.png" class="egg selectable" data-egg="8" />
        </div>
        <button id="confirm-egg-btn" disabled>Conferma Uovo</button>
      </div>
    </div>

    <!-- Gioco -->
    <div id="game" class="fullscreen center hidden">
      <button id="logout-btn" type="button">Logout</button>
      <div class="form-box">
        <!-- HUD compatto (mobile-first) -->
<div id="hud-compact" class="hud-compact hidden">
  <span class="hud-item">‚≠ê <b id="hud-level">1</b></span>
  <span class="hud-item">‚ö° <b id="hud-exp">0%</b></span>
  <span class="hud-item">üçñ <b id="hud-hunger">0</b></span>
  <span class="hud-item">üéâ <b id="hud-fun">0</b></span>
  <span class="hud-item">üßº <b id="hud-clean">0</b></span>
  <button id="open-minigames" class="hud-cta" type="button" aria-label="Apri minigiochi">üéÆ</button>
</div>

        <div id="level-container" class="level-box">
          <span id="level-label">Livello 1</span>
          <div id="exp-bar-bg" style="display:flex;align-items:center;gap:7px;">
            <span id="exp-label" style="font-size:0.95em;color:#888;font-weight:600;">exp</span>
            <div style="flex:1; position:relative;">
              <div id="exp-bar" style="height:16px;"></div>
              <span id="exp-gain-label" class="exp-gain-label" style="position:absolute;right:5px;top:50%;transform:translateY(-50%);display:none;"></span>
            </div>
          </div>
        </div>
        <img id="pet" alt="Il tuo pet" />
        <div class="bars">
          <div class="bar-label">Fame</div>
          <div id="hunger-bar" class="bar"></div>
          <div class="bar-label">Divertimento</div>
          <div id="fun-bar" class="bar"></div>
          <div class="bar-label">Pulizia</div>
          <div id="clean-bar" class="bar"></div>
        </div>
        <div class="controls">
          <button id="feed-btn" type="button">üçñ Feed</button>
          <button id="play-btn" type="button">üéÆ Play</button>
          <button id="clean-btn" type="button">üßº Clean</button>
        </div>
        <div id="game-over" class="hidden">
          üíî Il tuo pet √® scappato! Vuoi scegliere un nuovo uovo?
          <div id="game-over-buttons">
            <button id="choose-egg-btn" type="button">S√¨</button>
            <button id="exit-btn" type="button">No</button>
          </div>
        </div>
      </div>
    </div>

<!-- ===== MODALE MINIGIOCO CACCIA AL TESORO ===== -->
<div id="treasure-minigame-modal" class="treasure-minigame-modal hidden">
  <div class="treasure-mobile-layout">
    <!-- Barra info -->
    <div class="treasure-info-bar">
      <span>
        <img src="assets/collectibles/coin.png" class="info-icon" style="width:18px;vertical-align:middle;">
        <span id="treasure-minigame-coins">0</span>
      </span>
      <span>
        <img src="assets/bonus/clock.png" class="info-icon" style="width:18px;vertical-align:middle;">
        <span id="treasure-timer">--</span>s
      </span>
      <span>
        <img src="assets/icons/door.png" class="info-icon" style="width:18px;vertical-align:middle;">
        <span id="treasure-level">1</span>
      </span>
      <span>
        <img src="assets/bonus/clock.png" class="info-icon" style="width:18px;vertical-align:middle;">
        <span id="treasure-minigame-score">0</span>
      </span>
      <div class="treasure-exit-area" style="float:right; margin-left:24px;">
        <button id="treasure-exit-btn" class="treasure-exit-btn">Esci</button>
      </div>
    </div>
    <!-- Dungeon (canvas) -->
    <div class="treasure-dungeon-area" style="position:relative;">
      <canvas id="treasure-canvas"></canvas>
      <span id="treasure-bonus-label"
        style="display:none; position:absolute; left:50%; top:24px; transform:translateX(-50%); font-size:2.2em; color:#ffe44c; font-family:'Luckiest Guy',cursive; text-shadow:2px 2px 6px #000,0 0 24px #fff"></span>
      <div id="treasure-feedback-label"></div>
     <!-- Overlay joystick touch -->
<div class="treasure-joystick-overlay">
  <div class="treasure-joystick-base" id="treasure-joystick-base">
    <div class="treasure-joystick-stick" id="treasure-joystick-stick"></div>
  </div>
</div>
    </div>
  </div>
</div>


    <!-- MODALE SELEZIONE MINIGIOCO -->
    <div id="minigame-select-modal" class="modal hidden">
      <div class="modal-content" style="text-align:center;">
        <h2>Scegli un mini gioco</h2>
        <button id="btn-minigame-treasure" class="minigame-btn">Caccia al Tesoro</button>

        <!-- Qui in futuro puoi aggiungere altri bottoni/mini giochi -->
        <br>
        <button id="btn-minigame-cancel" class="minigame-btn" style="margin-top:18px;">Chiudi</button>
      </div>
    </div>

  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    window.SUPABASE_URL = 'https://jfycifybshoawhwechdd.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmeWNpZnlic2hvYXdod2VjaGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNzM0MDQsImV4cCI6MjA2OTY0OTQwNH0.Gsttr6PLvWIcdwum1WUQXml6BjHsXwYn94BEcyPaZHg';
  </script>
  <script>
(function(){
  // Prendi riferimenti
  const hud = {
    wrap: document.getElementById('hud-compact'),
    level: document.getElementById('hud-level'),
    exp: document.getElementById('hud-exp'),
    hunger: document.getElementById('hud-hunger'),
    fun: document.getElementById('hud-fun'),
    clean: document.getElementById('hud-clean'),
    openMinigames: document.getElementById('open-minigames'),
  };

  const els = {
    levelLabel: document.getElementById('level-label'),
    expBar: document.getElementById('exp-bar'),
    expBarBg: document.getElementById('exp-bar-bg'),
    hungerBar: document.getElementById('hunger-bar'),
    funBar: document.getElementById('fun-bar'),
    cleanBar: document.getElementById('clean-bar'),
    minigameModal: document.getElementById('minigame-select-modal'),
    minigameCancel: document.getElementById('btn-minigame-cancel'),
    login: document.getElementById('login-container'),
    eggSel: document.getElementById('egg-selection'),
    game: document.getElementById('game'),
  };

  // Helper: percentuale da una barra (usa width inline se c'√®, altrimenti calcola)
  function getPercentFromBar(barEl, bgEl){
    if (!barEl) return 0;
    // 1) prova a leggere "width: 37%;" inline
    const inline = barEl.style.width;
    if (inline && inline.includes('%')) {
      const v = parseFloat(inline);
      return isFinite(v) ? Math.max(0, Math.min(100, v)) : 0;
    }
    // 2) fallback: ratio tra width computate
    if (bgEl) {
      const bw = barEl.getBoundingClientRect().width;
      const bgw = bgEl.getBoundingClientRect().width;
      if (bgw > 0) return Math.round((bw / bgw) * 100);
    }
    return 0;
  }

  function getLevelFromLabel(){
    // es: "Livello 3" -> 3
    if (!els.levelLabel) return 1;
    const m = (els.levelLabel.textContent || '').match(/(\d+)/);
    return m ? parseInt(m[1], 10) : 1;
  }

  function getExpPercent(){
    return getPercentFromBar(els.expBar, els.expBarBg);
  }

  function syncHUD(){
    if (!hud.wrap) return;
    hud.level.textContent = getLevelFromLabel();
    hud.exp.textContent   = getExpPercent() + '%';
    hud.hunger.textContent = getPercentFromBar(els.hungerBar, els.hungerBar?.parentElement);
    hud.fun.textContent    = getPercentFromBar(els.funBar, els.funBar?.parentElement);
    hud.clean.textContent  = getPercentFromBar(els.cleanBar, els.cleanBar?.parentElement);
  }

  // Mostra HUD quando si entra nel gioco
    const isMobileCoarse = () =>
    window.matchMedia('(hover: none) and (pointer: coarse)').matches;

  function toggleHUD(){
    const inGame = !els.game.classList.contains('hidden');
    const onMobile = isMobileCoarse();
    if (inGame && onMobile) hud.wrap.classList.remove('hidden');
    else hud.wrap.classList.add('hidden');
  }

  // Apri/chiudi selezione minigiochi
  if (hud.openMinigames && els.minigameModal){
    hud.openMinigames.addEventListener('click', ()=>{
      els.minigameModal.classList.remove('hidden');
    });
  }
  if (els.minigameCancel){
    els.minigameCancel.addEventListener('click', ()=>{
      els.minigameModal.classList.add('hidden');
    });
  }

  // Aggiorna quando cambiano le barre/exp/level
  const obs = new MutationObserver(()=> syncHUD());
  [els.expBar, els.hungerBar, els.funBar, els.cleanBar, els.levelLabel].forEach(el=>{
    if (el) obs.observe(el, { attributes:true, attributeFilter:['style','class'], characterData:true, subtree:true, childList:true });
  });

  // Aggiorna quando si passa da login/egg a gioco
  const visObs = new MutationObserver(()=>{
    toggleHUD();
    syncHUD();
  });
  [els.login, els.eggSel, els.game].forEach(el=>{
    if (el) visObs.observe(el, { attributes:true, attributeFilter:['class'] });
  });

  // Primo sync quando il DOM √® pronto
  document.addEventListener('DOMContentLoaded', ()=>{
    toggleHUD();
    syncHUD();
  });

  // (Facoltativo) Se da qualche parte aggiorni valori via funzioni globali, puoi richiamare window.syncHUD()
  window.syncHUD = syncHUD;
})();
</script>

<script src="minigame-cacciaTesoro.js"></script>
<script>
(function(){
  const modal = document.getElementById('minigame-select-modal');
  const openHudBtn = document.getElementById('open-minigames');      // üéÆ nell‚ÄôHUD
  const desktopPlayBtn = document.getElementById('play-btn');        // Play desktop
  const treasureBtn = document.getElementById('btn-minigame-treasure');
  const cancelBtn = document.getElementById('btn-minigame-cancel');

  // Apri il menu minigiochi (HUD mobile + Play desktop)
  function openMinigames(){
    if (modal) modal.classList.remove('hidden');
  }
  openHudBtn?.addEventListener('click', openMinigames);
  desktopPlayBtn?.addEventListener('click', openMinigames);

  // Avvia Caccia al Tesoro
  function startTreasure(){
    // chiudi la modale, poi avvia il minigioco
    modal?.classList.add('hidden');
    if (typeof window.startTreasureMinigame === 'function') {
      window.startTreasureMinigame();
    } else {
      console.warn('startTreasureMinigame non √® ancora disponibile');
      // retry veloce nel caso lo script non fosse ancora pronto
      setTimeout(()=> window.startTreasureMinigame?.(), 50);
    }
  }
  treasureBtn?.addEventListener('click', startTreasure);

  // Chiudi la modale
  cancelBtn?.addEventListener('click', ()=> modal?.classList.add('hidden'));
})();
</script>

<script src="script.js"></script>
</body>
</html>
