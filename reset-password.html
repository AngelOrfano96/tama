<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Imposta nuova password</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="fullscreen center">
    <div class="form-box" style="max-width:380px;">
      <h2>Nuova password</h2>
      <p class="muted" id="reset-info" style="margin-bottom:10px;">
        Inserisci la nuova password e conferma.
      </p>

      <form id="reset-form">
        <input id="new-password" type="password" placeholder="Nuova password" required />
        <input id="new-password-2" type="password" placeholder="Conferma password" required />
        <div id="reset-msg" class="error" style="min-height:18px;"></div>
        <div class="buttons" style="margin-top:6px;">
          <button id="reset-submit" type="submit" class="ui-btn" style="width:100%;">Salva</button>
        </div>
      </form>

      <div style="margin-top:10px;">
        <a href="index.html" class="link-btn">Torna al login</a>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseClient = supabase.createClient(
      'https://jfycifybshoawhwechdd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmeWNpZnlic2hvYXdod2VjaGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNzM0MDQsImV4cCI6MjA2OTY0OTQwNH0.Gsttr6PLvWIcdwum1WUQXml6BjHsXwYn94BEcyPaZHg'
    );

    const form   = document.getElementById('reset-form');
    const p1     = document.getElementById('new-password');
    const p2     = document.getElementById('new-password-2');
    const msg    = document.getElementById('reset-msg');
    const submit = document.getElementById('reset-submit');

    // All'arrivo: prova a creare una sessione dal link (PKCE o Implicit)
    async function boot() {
      try {
        const url = window.location.href;
        const search = new URLSearchParams(location.search);
        const hash   = new URLSearchParams(location.hash.slice(1));

        if (search.has('code')) {
          // Flow PKCE
          const { error } = await supabaseClient.auth.exchangeCodeForSession(url);
          if (error) throw error;
          history.replaceState({}, '', location.pathname);
        } else if (hash.get('access_token')) {
          // Flow Implicit (fallback)
          const { error } = await supabaseClient.auth.setSession({
            access_token: hash.get('access_token'),
            refresh_token: hash.get('refresh_token')
          });
          if (error) throw error;
          history.replaceState({}, '', location.pathname);
        } else {
          msg.textContent = 'Link non valido o scaduto. Richiedi un nuovo link.';
          submit.disabled = true;
          form.setAttribute('aria-disabled', 'true');
        }
      } catch (e) {
        console.error('[boot]', e);
        msg.textContent = 'Link non valido o scaduto. Richiedi un nuovo link.';
        submit.disabled = true;
      }
    }

    boot();

    // Salva nuova password
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const pass  = (p1.value || '').trim();
      const pass2 = (p2.value || '').trim();

      if (pass.length < 6) { msg.textContent = 'Almeno 6 caratteri.'; return; }
      if (pass !== pass2)  { msg.textContent = 'Le password non coincidono.'; return; }

      submit.disabled = true;
      msg.textContent = 'Aggiornamento in corso...';

      try {
        const { error } = await supabaseClient.auth.updateUser({ password: pass });
        if (error) throw error;

        msg.textContent = 'Password aggiornata! Ora puoi accedere.';
        await supabaseClient.auth.signOut();
        // Redirect opzionale:
        // window.location.href = 'index.html';
      } catch (err) {
        console.error('[reset-password]', err);
        msg.textContent = 'Impossibile aggiornare la password. Apri di nuovo il link dalla mail o richiedine uno nuovo.';
      } finally {
        submit.disabled = false;
      }
    });
  </script>
</body>
</html>
