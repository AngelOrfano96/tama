<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Imposta nuova password</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="fullscreen center">
    <div class="form-box" style="max-width:380px;">
      <h2>Nuova password</h2>
      <p class="muted" style="margin-bottom:10px" id="rp-info">
        Inserisci la nuova password e conferma.
      </p>

      <input id="rp-pass" type="password" placeholder="Nuova password" required>
      <input id="rp-pass2" type="password" placeholder="Conferma password" required>

      <div id="rp-msg" class="error" style="min-height:18px;"></div>

      <div class="buttons" style="margin-top:6px;">
        <button id="rp-save" class="ui-btn" style="width:100%;">Salva</button>
      </div>

      <div style="margin-top:10px;">
        <a href="index.html" class="link-btn">Torna al login</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseClient = supabase.createClient(window.SUPABASE_URL || 'https://jfycifybshoawhwechdd.supabase.co', 
                                                 window.SUPABASE_ANON_KEY || '<?= la tua anon key ?>');

    // Quando arrivi da email, Supabase appende alla URL i parametri (#access_token / error ecc.)
    // Se il link Ã¨ scaduto, mostriamo subito un messaggio.
    const hash = new URL(window.location.href).hash || '';
    const urlParams = new URLSearchParams(hash.replace(/^#/, ''));
    const err = urlParams.get('error') || urlParams.get('error_code');
    const errDesc = urlParams.get('error_description');

    const msg = document.getElementById('rp-msg');
    const info = document.getElementById('rp-info');

    if (err) {
      msg.textContent = (errDesc || 'Link non valido o scaduto.');
    }

    document.getElementById('rp-save').addEventListener('click', async () => {
      msg.textContent = '';

      const p1 = document.getElementById('rp-pass').value;
      const p2 = document.getElementById('rp-pass2').value;

      if (!p1 || p1.length < 6) { msg.textContent = 'La password deve avere almeno 6 caratteri.'; return; }
      if (p1 !== p2)            { msg.textContent = 'Le password non coincidono.'; return; }

      try {
        const { data, error } = await supabaseClient.auth.updateUser({ password: p1 });
        if (error) throw error;

        msg.style.color = '#16a34a';
        msg.textContent = 'Password aggiornata! Ora puoi accedere.';
        // opzionale: redirect al login dopo poco
        setTimeout(() => { window.location.href = 'index.html'; }, 1200);
      } catch (e) {
        console.error('[reset-password]', e);
        msg.style.color = '#e74c3c';
        msg.textContent = 'Impossibile aggiornare la password. Riapri il link dalla mail o richiedine uno nuovo.';
      }
    });
  </script>

  <!-- Inietto le stesse variabili globali usate su index -->
  <script>
    window.SUPABASE_URL = 'https://jfycifybshoawhwechdd.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmeWNpZnlic2hvYXdod2VjaGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNzM0MDQsImV4cCI6MjA2OTY0OTQwNH0.Gsttr6PLvWIcdwum1WUQXml6BjHsXwYn94BEcyPaZHg';
  </script>
  <script src="script.js"></script>
</body>
</html>
